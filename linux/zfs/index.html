<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="My personal digital garden"><meta name=author content=Lyz><link href=https://memo.nullniverse.xyz/linux/zfs/ rel=canonical><link href=../../storage/ rel=prev><link href=../../zfs_storage_planning/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.1.21"><title>ZFS - My Memo</title><link rel=stylesheet href=../../assets/stylesheets/main.eebd395e.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ecc896b0.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeago.css><link rel=stylesheet href=../../stylesheets/extra.css><link rel=stylesheet href=../../stylesheets/links.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#usage class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> For current posts check out my blog <a href=https://blog.nullniverse.xyz/ ><strong>RSS feed</strong></a> <img src=/theme/assets/images/blog_icon.png height=15 width=15> </div> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="My Memo" class="md-header__button md-logo" aria-label="My Memo" data-md-component=logo> <img src=../../img/logo.bmp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> My Memo </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ZFS </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/nullniverse/memo title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> nullniverse/memo </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="My Memo" class="md-nav__button md-logo" aria-label="My Memo" data-md-component=logo> <img src=../../img/logo.bmp alt=logo> </a> My Memo </label> <div class=md-nav__source> <a href=https://github.com/nullniverse/memo title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> nullniverse/memo </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../contact/ class=md-nav__link> Contact </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/devops/ >DevOps</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> DevOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> Infrastructure as Code <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Infrastructure as Code </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitea/ class=md-nav__link> Gitea </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1_2> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/helm/helm/ >Helm</a> <label for=__nav_3_1_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1_2> <span class="md-nav__icon md-icon"></span> Helm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/helm/helm_installation/ class=md-nav__link> Helm Installation </a> </li> <li class=md-nav__item> <a href=../../devops/helm/helm_commands/ class=md-nav__link> Helm Commands </a> </li> <li class=md-nav__item> <a href=../../devops/helm/helm_secrets/ class=md-nav__link> Helm Secrets </a> </li> <li class=md-nav__item> <a href=../../helm_git/ class=md-nav__link> Helm Git </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../devops/helmfile/ class=md-nav__link> Helmfile </a> </li> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=../../ansible_snippets/ class=md-nav__link> Ansible Snippets </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1_6> <div class="md-nav__link md-nav__link--index "> <a href=../../dotfiles/ >Dotfiles</a> <label for=__nav_3_1_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1_6> <span class="md-nav__icon md-icon"></span> Dotfiles </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chezmoi/ class=md-nav__link> Chezmoi </a> </li> <li class=md-nav__item> <a href=../../dotdrop/ class=md-nav__link> Dotdrop </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> Infrastructure Solutions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Infrastructure Solutions </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/kubernetes/kubernetes/ >Kubernetes</a> <label for=__nav_3_2_1> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_architecture/ class=md-nav__link> Architecture </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1_2> <label class=md-nav__link for=__nav_3_2_1_2 id=__nav_3_2_1_2_label tabindex=0> Resources <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1_2> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_namespaces/ class=md-nav__link> Namespaces </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_pods/ class=md-nav__link> Pods </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_replicasets/ class=md-nav__link> ReplicaSets </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_deployments/ class=md-nav__link> Deployments </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_volumes/ class=md-nav__link> Volumes </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_services/ class=md-nav__link> Services </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_labels/ class=md-nav__link> Labels </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_annotations/ class=md-nav__link> Annotations </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_ingress/ class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_operators/ class=md-nav__link> Operators </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_jobs/ class=md-nav__link> Jobs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1_3> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/kubectl/kubectl/ >Kubectl</a> <label for=__nav_3_2_1_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1_3> <span class="md-nav__icon md-icon"></span> Kubectl </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/kubectl/kubectl_installation/ class=md-nav__link> Kubectl Installation </a> </li> <li class=md-nav__item> <a href=../../devops/kubectl/kubectl_commands/ class=md-nav__link> Kubectl Commands </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1_4> <label class=md-nav__link for=__nav_3_2_1_4 id=__nav_3_2_1_4_label tabindex=0> Additional Components <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1_4> <span class="md-nav__icon md-icon"></span> Additional Components </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_metric_server/ class=md-nav__link> Metrics Server </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_ingress_controller/ class=md-nav__link> Ingress Controller </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_external_dns/ class=md-nav__link> External DNS </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_cluster_autoscaler/ class=md-nav__link> Cluster Autoscaler </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_dashboard/ class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_storage_driver/ class=md-nav__link> Storage Driver </a> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_vertical_pod_autoscaler/ class=md-nav__link> Vertical Pod Autoscaler </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../devops/kubernetes/kubernetes_networking/ class=md-nav__link> Networking </a> </li> <li class=md-nav__item> <a href=../../kubernetes_debugging/ class=md-nav__link> Debugging </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1_7> <label class=md-nav__link for=__nav_3_2_1_7 id=__nav_3_2_1_7_label tabindex=0> Backups <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1_7> <span class="md-nav__icon md-icon"></span> Backups </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../velero/ class=md-nav__link> Velero </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_1_8> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/kubernetes/kubernetes_tools/ >Tools</a> <label for=__nav_3_2_1_8> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_1_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_1_8> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../krew/ class=md-nav__link> Krew </a> </li> <li class=md-nav__item> <a href=../../ksniff/ class=md-nav__link> Ksniff </a> </li> <li class=md-nav__item> <a href=../../mizu/ class=md-nav__link> Mizu </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_2> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/aws/aws/ >AWS</a> <label for=__nav_3_2_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_2> <span class="md-nav__icon md-icon"></span> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws_snippets/ class=md-nav__link> AWS Snippets </a> </li> <li class=md-nav__item> <a href=../../aws_savings_plan/ class=md-nav__link> AWS Savings plan </a> </li> <li class=md-nav__item> <a href=../../devops/aws/security_groups/ class=md-nav__link> Security groups workflow </a> </li> <li class=md-nav__item> <a href=../../devops/aws/eks/ class=md-nav__link> EKS </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2_2_5> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/aws/iam/iam/ >IAM</a> <label for=__nav_3_2_2_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_2_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2_2_5> <span class="md-nav__icon md-icon"></span> IAM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/aws/iam/iam_commands/ class=md-nav__link> IAM Commands </a> </li> <li class=md-nav__item> <a href=../../devops/aws/iam/iam_debug/ class=md-nav__link> IAM Debugging </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../devops/aws/s3/ class=md-nav__link> S3 </a> </li> <li class=md-nav__item> <a href=../../aws_waf/ class=md-nav__link> WAF </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/ci/ >Continuous Integration</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Continuous Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../drone/ class=md-nav__link> Drone </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3_2> <label class=md-nav__link for=__nav_3_3_2 id=__nav_3_3_2_label tabindex=0> Linters <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3_2> <span class="md-nav__icon md-icon"></span> Linters </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/alex/ class=md-nav__link> Alex </a> </li> <li class=md-nav__item> <a href=../../flakeheaven/ class=md-nav__link> Flakeheaven </a> </li> <li class=md-nav__item> <a href=../../devops/flake8/ class=md-nav__link> Flake8 </a> </li> <li class=md-nav__item> <a href=../../devops/markdownlint/ class=md-nav__link> Markdownlint </a> </li> <li class=md-nav__item> <a href=../../devops/proselint/ class=md-nav__link> Proselint </a> </li> <li class=md-nav__item> <a href=../../devops/yamllint/ class=md-nav__link> Yamllint </a> </li> <li class=md-nav__item> <a href=../../devops/write_good/ class=md-nav__link> Write Good </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3_3> <label class=md-nav__link for=__nav_3_3_3 id=__nav_3_3_3_label tabindex=0> Formatters/Fixers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3_3> <span class="md-nav__icon md-icon"></span> Formatters/Fixers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/black/ class=md-nav__link> Black </a> </li> <li class=md-nav__item> <a href=../../yamlfix/ class=md-nav__link> Yamlfix </a> </li> <li class=md-nav__item> <a href=../../pyment/ class=md-nav__link> Pyment </a> </li> <li class=md-nav__item> <a href=../../mdformat/ class=md-nav__link> mdformat </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3_4> <label class=md-nav__link for=__nav_3_3_4 id=__nav_3_3_4_label tabindex=0> Type Checkers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3_4> <span class="md-nav__icon md-icon"></span> Type Checkers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/mypy/ class=md-nav__link> Mypy </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3_5> <label class=md-nav__link for=__nav_3_3_5 id=__nav_3_3_5_label tabindex=0> Security Checkers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3_5> <span class="md-nav__icon md-icon"></span> Security Checkers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/safety/ class=md-nav__link> Safety </a> </li> <li class=md-nav__item> <a href=../../devops/bandit/ class=md-nav__link> Bandit </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3_6> <label class=md-nav__link for=__nav_3_3_6 id=__nav_3_3_6_label tabindex=0> Dependency managers <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3_6> <span class="md-nav__icon md-icon"></span> Dependency managers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/pip_tools/ class=md-nav__link> Pip-tools </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> Automating Processes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Automating Processes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../cookiecutter/ class=md-nav__link> cookiecutter </a> </li> <li class=md-nav__item> <a href=../cruft/ class=md-nav__link> cruft </a> </li> <li class=md-nav__item> <a href=../../renovate/ class=md-nav__link> renovate </a> </li> <li class=md-nav__item> <a href=../../letsencrypt/ class=md-nav__link> letsencrypt </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../storage/ >Storage</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=true> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5_1 checked> <div class="md-nav__link md-nav__link--index md-nav__link--active"> <a href=./ >OpenZFS</a> <label for=__nav_3_5_1> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_5_1_label aria-expanded=true> <label class=md-nav__title for=__nav_3_5_1> <span class="md-nav__icon md-icon"></span> OpenZFS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zfs_storage_planning/ class=md-nav__link> OpenZFS storage planning </a> </li> <li class=md-nav__item> <a href=../../sanoid/ class=md-nav__link> Sanoid </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex=0> Monitoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../monitoring_comparison/ class=md-nav__link> Monitoring Comparison </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6_2> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/prometheus/prometheus/ >Prometheus</a> <label for=__nav_3_6_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6_2> <span class="md-nav__icon md-icon"></span> Prometheus </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/prometheus/prometheus_architecture/ class=md-nav__link> Architecture </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/prometheus_operator/ class=md-nav__link> Prometheus Operator </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/prometheus_installation/ class=md-nav__link> Prometheus Install </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/alertmanager/ class=md-nav__link> AlertManager </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/blackbox_exporter/ class=md-nav__link> Blackbox Exporter </a> </li> <li class=md-nav__item> <a href=../../elasticsearch_exporter/ class=md-nav__link> Elasticsearch Exporter </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/node_exporter/ class=md-nav__link> Node Exporter </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/instance_sizing_analysis/ class=md-nav__link> Instance sizing analysis </a> </li> <li class=md-nav__item> <a href=../../devops/prometheus/prometheus_troubleshooting/ class=md-nav__link> Prometheus Troubleshooting </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_7> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex=0> Authentication <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=false> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Authentication </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../authentik/ class=md-nav__link> Authentik </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex=0> Self-hosted services <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> Self-hosted services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ombi/ class=md-nav__link> Ombi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_9> <div class="md-nav__link md-nav__link--index "> <a href=../../devops/api_management/ >API Management</a> <label for=__nav_3_9> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_9_label aria-expanded=false> <label class=md-nav__title for=__nav_3_9> <span class="md-nav__icon md-icon"></span> API Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devops/kong/kong/ class=md-nav__link> Kong </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../language/language/ class=md-nav__link> Language Learning </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#usage class=md-nav__link> Usage </a> <nav class=md-nav aria-label=Usage> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mount-a-pool-as-readonly class=md-nav__link> Mount a pool as readonly </a> </li> <li class=md-nav__item> <a href=#mount-a-zfs-snapshot-in-a-directory-as-readonly class=md-nav__link> Mount a ZFS snapshot in a directory as readonly </a> </li> <li class=md-nav__item> <a href=#list-pools class=md-nav__link> List pools </a> </li> <li class=md-nav__item> <a href=#list-the-filesystems class=md-nav__link> List the filesystems </a> </li> <li class=md-nav__item> <a href=#get-read-and-write-stats-from-pool class=md-nav__link> Get read and write stats from pool </a> </li> <li class=md-nav__item> <a href=#get-all-properties-of-a-pool class=md-nav__link> Get all properties of a pool </a> </li> <li class=md-nav__item> <a href=#get-all-properties-of-a-filesystem class=md-nav__link> Get all properties of a filesystem </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installation class=md-nav__link> Installation </a> <nav class=md-nav aria-label=Installation> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-the-required-programs class=md-nav__link> Install the required programs </a> </li> <li class=md-nav__item> <a href=#create-your-pool class=md-nav__link> Create your pool </a> </li> <li class=md-nav__item> <a href=#create-your-filesystems class=md-nav__link> Create your filesystems </a> </li> <li class=md-nav__item> <a href=#enable-the-autoloading-of-datasets-on-boot class=md-nav__link> Enable the autoloading of datasets on boot </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-nfs class=md-nav__link> Configure NFS </a> <nav class=md-nav aria-label="Configure NFS"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-nfs class=md-nav__link> Install NFS </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backup class=md-nav__link> Backup </a> <nav class=md-nav aria-label=Backup> <ul class=md-nav__list> <li class=md-nav__item> <a href=#zfs-snapshot-lifecycle-management class=md-nav__link> ZFS snapshot lifecycle management </a> </li> <li class=md-nav__item> <a href=#restore-a-backup class=md-nav__link> Restore a backup </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#learning class=md-nav__link> Learning </a> </li> <li class=md-nav__item> <a href=#resources class=md-nav__link> Resources </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>OpenZFS</h1> <p><a href=https://en.wikipedia.org/wiki/ZFS>OpenZFS</a> is a file system with volume management capabilities designed specifically for storage servers.</p> <p>Some neat features of ZFS include:</p> <ul> <li>Aggregating multiple physical disks into a single filesystem.</li> <li>Automatically repairing data corruption.</li> <li>Creating point-in-time snapshots of data on disk.</li> <li>Optionally encrypting or compressing data on disk.</li> </ul> <h2 id=usage>Usage<a class=headerlink href=#usage title="Permanent link">⚑</a></h2> <h3 id=mount-a-pool-as-readonly>Mount a pool as readonly<a class=headerlink href=#mount-a-pool-as-readonly title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>import<span class=w> </span>-o<span class=w> </span><span class=nv>readonly</span><span class=o>=</span>on<span class=w> </span><span class=o>{{</span><span class=w> </span>pool_name<span class=w> </span><span class=o>}}</span>
</code></pre></div> <h3 id=mount-a-zfs-snapshot-in-a-directory-as-readonly>Mount a ZFS snapshot in a directory as readonly<a class=headerlink href=#mount-a-zfs-snapshot-in-a-directory-as-readonly title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>mount<span class=w> </span>-t<span class=w> </span>zfs<span class=w> </span><span class=o>{{</span><span class=w> </span>pool_name<span class=w> </span><span class=o>}}</span>/<span class=o>{{</span><span class=w> </span>snapshot_name<span class=w> </span><span class=o>}}</span><span class=w> </span><span class=o>{{</span><span class=w> </span>mount_path<span class=w> </span><span class=o>}}</span><span class=w> </span>-o<span class=w> </span>ro
</code></pre></div> <h3 id=list-pools>List pools<a class=headerlink href=#list-pools title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>list
</code></pre></div> <h3 id=list-the-filesystems>List the filesystems<a class=headerlink href=#list-the-filesystems title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zfs<span class=w> </span>list
</code></pre></div> <h3 id=get-read-and-write-stats-from-pool>Get read and write stats from pool<a class=headerlink href=#get-read-and-write-stats-from-pool title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>iostat<span class=w> </span>-v<span class=w> </span><span class=o>{{</span><span class=w> </span>pool_name<span class=w> </span><span class=o>}}</span><span class=w> </span><span class=o>{{</span><span class=w> </span>refresh_time_in_seconds<span class=w> </span><span class=o>}}</span>
</code></pre></div> <h3 id=get-all-properties-of-a-pool>Get all properties of a pool<a class=headerlink href=#get-all-properties-of-a-pool title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>get<span class=w> </span>all<span class=w> </span><span class=o>{{</span><span class=w> </span>pool_name<span class=w> </span><span class=o>}}</span>
</code></pre></div> <h3 id=get-all-properties-of-a-filesystem>Get all properties of a filesystem<a class=headerlink href=#get-all-properties-of-a-filesystem title="Permanent link">⚑</a></h3> <div class=highlight><pre><span></span><code>zfs<span class=w> </span>get<span class=w> </span>all<span class=w> </span><span class=o>{{</span><span class=w> </span>pool_name<span class=w> </span><span class=o>}}</span>
</code></pre></div> <h2 id=installation>Installation<a class=headerlink href=#installation title="Permanent link">⚑</a></h2> <h3 id=install-the-required-programs>Install the required programs<a class=headerlink href=#install-the-required-programs title="Permanent link">⚑</a></h3> <p>OpenZFS is not in the mainline kernel for license issues (fucking capitalism...) so it's not yet suggested to use it for the root of your filesystem. </p> <p>To install it in a Debian device:</p> <ul> <li>ZFS packages are included in the <code>contrib</code> repository, but the <code>backports</code> repository often provides newer releases of ZFS. You can use it as follows.</li> </ul> <p>Add the backports repository:</p> <div class=highlight><pre><span></span><code>vi<span class=w> </span>/etc/apt/sources.list.d/bullseye-backports.list
</code></pre></div> <div class=highlight><pre><span></span><code>deb http://deb.debian.org/debian bullseye-backports main contrib
deb-src http://deb.debian.org/debian bullseye-backports main contrib
</code></pre></div> <div class=highlight><pre><span></span><code>vi<span class=w> </span>/etc/apt/preferences.d/90_zfs
</code></pre></div> <div class=highlight><pre><span></span><code>Package: src:zfs-linux
Pin: release n=bullseye-backports
Pin-Priority: 990
</code></pre></div> <ul> <li>Install the packages:</li> </ul> <div class=highlight><pre><span></span><code>apt<span class=w> </span>update
apt<span class=w> </span>install<span class=w> </span>dpkg-dev<span class=w> </span>linux-headers-generic<span class=w> </span>linux-image-generic
apt<span class=w> </span>install<span class=w> </span>zfs-dkms<span class=w> </span>zfsutils-linux
</code></pre></div> <p>BE CAREFUL: if root doesn't have <code>sbin</code> in the <code>PATH</code> you will get an error of loading the zfs module as it's not signed. If this happens to you reinstall or try the debugging I did (which didn't work).</p> <h3 id=create-your-pool><a href=https://pthree.org/2012/12/04/zfs-administration-part-i-vdevs/ >Create your pool</a><a class=headerlink href=#create-your-pool title="Permanent link">⚑</a></h3> <p>First read the <a href=../../zfs_storage_planning/ >ZFS storage planning</a> article and then create your <code>main</code> pool with a command similar to:</p> <div class=highlight><pre><span></span><code>zpool<span class=w> </span>create<span class=w> </span><span class=se>\</span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>ashift</span><span class=o>=</span><span class=m>12</span><span class=w> </span><span class=se>\ </span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>autoexpand</span><span class=o>=</span>on<span class=w> </span><span class=se>\ </span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>compression</span><span class=o>=</span>lz4<span class=w> </span><span class=se>\</span>
main<span class=w> </span>raidz<span class=w> </span>/dev/sda<span class=w> </span>/dev/sdb<span class=w> </span>/dev/sdc<span class=w> </span>/dev/sdd<span class=w> </span><span class=se>\</span>
<span class=w>  </span>log<span class=w> </span>mirror<span class=w> </span><span class=se>\</span>
<span class=w>    </span>/dev/disk/by-id/nvme-eui.e823gqkwadgp32uhtpobsodkjfl2k9d0-part4<span class=w> </span><span class=se>\</span>
<span class=w>    </span>/dev/disk/by-id/nvme-eui.a0sdgohosdfjlkgjwoqkegdkjfl2k9d0-part4<span class=w> </span><span class=se>\</span>
<span class=w>  </span>cache<span class=w> </span><span class=se>\</span>
<span class=w>    </span>/dev/disk/by-id/nvme-eui.e823gqkwadgp32uhtpobsodkjfl2k9d0-part5<span class=w> </span><span class=se>\</span>
<span class=w>    </span>/dev/disk/by-id/nvme-eui.a0sdgohosdfjlkgjwoqkegdkjfl2k9d0-part5<span class=w> </span><span class=se>\</span>
</code></pre></div> <p>Where:</p> <ul> <li><code>-o ashift=12</code>: Adjusts the disk sector size to the disks in use.</li> <li><code>-o canmount=off</code>: Don't mount the main pool, we'll mount the filesystems.</li> <li><code>-o compression=lz4</code>: Enable compression by default</li> <li><code>/dev/sda /dev/sdb /dev/sdc /dev/sdd</code> are the rotational data disks configured in RAIDZ1</li> <li>We set two partitions in mirror for the ZLOG</li> <li>We set two partitions in stripe for the L2ARC</li> </ul> <p>If you don't want the main pool to be mounted use <code>zfs set mountpoint=none main</code>.</p> <h3 id=create-your-filesystems><a href=https://pthree.org/2012/12/17/zfs-administration-part-x-creating-filesystems/ >Create your filesystems</a><a class=headerlink href=#create-your-filesystems title="Permanent link">⚑</a></h3> <p>Once we have the pool you can create the different filesystems. If you want to use encryption with a key follow the next steps:</p> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>/etc/zfs/keys
chmod<span class=w> </span><span class=m>700</span><span class=w> </span>/etc/zfs/keys
dd<span class=w> </span><span class=k>if</span><span class=o>=</span>/dev/random<span class=w> </span><span class=nv>of</span><span class=o>=</span>/etc/zfs/keys/home.key<span class=w> </span><span class=nv>bs</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>count</span><span class=o>=</span><span class=m>32</span>
</code></pre></div> <p>Then create the filesystem:</p> <div class=highlight><pre><span></span><code>zfs<span class=w> </span>create<span class=w> </span><span class=se>\ </span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>mountpoint</span><span class=o>=</span>/home/lyz<span class=w> </span><span class=se>\</span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>encryption</span><span class=o>=</span>on<span class=w> </span><span class=se>\</span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>keyformat</span><span class=o>=</span>raw<span class=w> </span><span class=se>\</span>
<span class=w>  </span>-o<span class=w> </span><span class=nv>keylocation</span><span class=o>=</span>file:///etc/zfs/keys/home.key<span class=w> </span><span class=se>\</span>
<span class=w>  </span>main/lyz
</code></pre></div> <p>I'm assuming that <code>compression</code> was set in the pool.</p> <p>You can check the created filesystems with <code>zfs list</code></p> <h3 id=enable-the-autoloading-of-datasets-on-boot>Enable the autoloading of datasets on boot<a class=headerlink href=#enable-the-autoloading-of-datasets-on-boot title="Permanent link">⚑</a></h3> <p>It is possible to automatically unlock a pool dataset on boot time by using a systemd unit. For example create the following service to unlock any specific dataset:</p> <div class=highlight><pre><span></span><code>/etc/systemd/system/zfs-load-key.service
</code></pre></div> <div class=highlight><pre><span></span><code>[Unit]
Description=Load encryption keys
DefaultDependencies=no
After=zfs-import.target
Before=zfs-mount.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/zfs load-key -a
StandardInput=tty-force

[Install]
WantedBy=zfs-mount.service
</code></pre></div> <div class=highlight><pre><span></span><code>systemctl<span class=w> </span>start<span class=w> </span>zfs-load-key.service
systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>zfs-load-key.service
reboot
</code></pre></div> <h2 id=configure-nfs><a href=https://pthree.org/2012/12/31/zfs-administration-part-xv-iscsi-nfs-and-samba/ >Configure NFS</a><a class=headerlink href=#configure-nfs title="Permanent link">⚑</a></h2> <p>With ZFS you can share a specific dataset via NFS. If for whatever reason the dataset does not mount, then the export will not be available to the application, and the NFS client will be blocked.</p> <p>You still must install the necessary daemon software to make the share available. For example, if you wish to share a dataset via NFS, then you need to install the NFS server software, and it must be running. Then, all you need to do is flip the sharing NFS switch on the dataset, and it will be immediately available.</p> <h3 id=install-nfs>Install NFS<a class=headerlink href=#install-nfs title="Permanent link">⚑</a></h3> <p>To share a dataset via NFS, you first need to make sure the NFS daemon is running. On Debian and Ubuntu, this is the <code>nfs-kernel-server</code> package. </p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>nfs-kernel-server
</code></pre></div> <p>Further, with Debian and Ubuntu, the NFS daemon will not start unless there is an export in the <code>/etc/exports</code> file. So, you have two options: you can create a dummy export, only available to localhost, or you can edit the init script to start without checking for a current export. I prefer the former. Let's get that setup:</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;/tmp localhost(ro)&#39;</span><span class=w> </span>&gt;&gt;<span class=w> </span>/etc/exports
$<span class=w> </span>sudo<span class=w> </span>/etc/init.d/nfs-kernel-server<span class=w> </span>start
$<span class=w> </span>showmount<span class=w> </span>-e<span class=w> </span>hostname.example.com
Export<span class=w> </span>list<span class=w> </span><span class=k>for</span><span class=w> </span>hostname.example.com:
/mnt<span class=w> </span>localhost
</code></pre></div> <p>With our NFS daemon running, we can now start sharing ZFS datasets. The <code>sharenfs</code> property can be <code>on</code>, <code>off</code> or <code>opts</code>, where <code>opts</code> are valid NFS export options. So, if you want to share the <code>pool/srv</code> dataset, which is mounted to <code>/srv</code> to the <code>10.80.86.0/24</code> network you could run:</p> <div class=highlight><pre><span></span><code><span class=c1># zfs set sharenfs=&quot;rw=@10.80.86.0/24&quot; pool/srv</span>
<span class=c1># zfs share pool/srv</span>
<span class=c1># showmount -e hostname.example.com</span>
Export<span class=w> </span>list<span class=w> </span><span class=k>for</span><span class=w> </span>hostname.example.com:
/srv<span class=w> </span><span class=m>10</span>.80.86.0/24
/mnt<span class=w> </span>localhost
</code></pre></div> <p>If you need to share to multiple subnets, you would do something like:</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>zfs<span class=w> </span><span class=nb>set</span><span class=w> </span><span class=nv>sharenfs</span><span class=o>=</span><span class=s2>&quot;rw=@192.168.0.0/24,rw=@10.0.0.0/24&quot;</span><span class=w> </span>pool-name/dataset-name
</code></pre></div> <p>If you need <code>root</code> to be able to write to the directory <a href=https://serverfault.com/questions/611007/unable-to-write-to-mount-point-nfs-server-getting-permission-denied>enable the <code>no_root_squash</code> NFS option</a></p> <blockquote> <p>root_squash — Prevents root users connected remotely from having root privileges and assigns them the user ID for the user nfsnobody. This effectively "squashes" the power of the remote root user to the lowest local user, preventing unauthorized alteration of files on the remote server. Alternatively, the no_root_squash option turns off root squashing. To squash every remote user, including root, use the all_squash option. To specify the user and group IDs to use with remote users from a particular host, use the anonuid and anongid options, respectively. In this case, a special user account can be created for remote NFS users to share and specify (anonuid=,anongid=), where is the user ID number and is the group ID number.</p> </blockquote> <p>You should now be able to mount the NFS export from an NFS client. Install the client with:</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>nfs-common
</code></pre></div> <p>And then mount it with:</p> <div class=highlight><pre><span></span><code>mount<span class=w> </span>-t<span class=w> </span>nfs<span class=w> </span>hostname.example.com:/srv<span class=w> </span>/mnt
</code></pre></div> <p>To permanently mount it you need to add it to your <code>/etc/fstab</code>, check <a href=../../linux_snippets/#configure-fstab-to-mount-nfs>this section for more details</a>.</p> <h2 id=backup>Backup<a class=headerlink href=#backup title="Permanent link">⚑</a></h2> <p>Please remember that <a href=https://serverfault.com/questions/2888/why-is-raid-not-a-backup>RAID is not a backup</a>, it guards against one kind of hardware failure. There's lots of failure modes that it doesn't guard against though:</p> <ul> <li>File corruption</li> <li>Human error (deleting files by mistake)</li> <li>Catastrophic damage (someone dumps water onto the server)</li> <li>Viruses and other malware</li> <li>Software bugs that wipe out data</li> <li>Hardware problems that wipe out data or cause hardware damage (controller malfunctions, firmware bugs, voltage spikes, ...)</li> </ul> <p>That's why you still need to make backups.</p> <p>ZFS has the builtin feature to make snapshots of the pool. A snapshot is a first class read-only filesystem. It is a mirrored copy of the state of the filesystem at the time you took the snapshot. They are persistent across reboots, and they don't require any additional backing store; they use the same storage pool as the rest of your data. </p> <p>If you remember <a href=https://pthree.org/2012/12/14/zfs-administration-part-ix-copy-on-write/ >ZFS's awesome nature of copy-on-write</a> filesystems, you will remember the discussion about Merkle trees. A ZFS snapshot is a copy of the Merkle tree in that state, except we make sure that the snapshot of that Merkle tree is never modified.</p> <p>Creating snapshots is near instantaneous, and they are cheap. However, once the data begins to change, the snapshot will begin storing data. If you have multiple snapshots, then multiple deltas will be tracked across all the snapshots. However, depending on your needs, snapshots can still be exceptionally cheap.</p> <h3 id=zfs-snapshot-lifecycle-management>ZFS snapshot lifecycle management<a class=headerlink href=#zfs-snapshot-lifecycle-management title="Permanent link">⚑</a></h3> <p>ZFS doesn't though have a clean way to manage the lifecycle of those snapshots. There are many tools to fill the gap:</p> <ul> <li><a href=../../sanoid/ ><code>sanoid</code></a>: Made in Perl, 2.4k stars, last commit April 2022, last release April 2021</li> <li><a href=https://github.com/zfsonlinux/zfs-auto-snapshot>zfs-auto-snapshot</a>: Made in Bash, 767 stars, last commit/release on September 2019</li> <li><a href=https://github.com/yboetz/pyznap>pyznap</a>: Made in Python, 176 stars, last commit/release on September 2020</li> <li>Custom scripts.</li> </ul> <p>It seems that the state of the art of ZFS backups is not changing too much in the last years, possibly because the functionality is covered so there is no need for further development. So I'm going to manage the backups with <a href=../../sanoid/ ><code>sanoid</code></a> despite it being done in Perl because <a href=../../sanoid/ >it's the most popular, it looks simple but flexible for complex cases, and it doesn't look I'd need to tweak the code</a>.</p> <h3 id=restore-a-backup><a href=https://pthree.org/2012/12/19/zfs-administration-part-xii-snapshots-and-clones/ >Restore a backup</a><a class=headerlink href=#restore-a-backup title="Permanent link">⚑</a></h3> <p>You can list the available snapshots of a filesystem with <code>zfs list -t snapshot {{ pool_or_filesystem_name }}</code>, if you don't specify the <code>pool_or_filesystem_name</code> it will show all available snapshots.</p> <p>You have two ways to restore a backup:</p> <ul> <li><a href=https://askubuntu.com/questions/103369/ubuntu-how-to-mount-zfs-snapshot>Mount the snapshot in a directory and manually copy the needed files</a>:</li> </ul> <div class=highlight><pre><span></span><code>mount<span class=w> </span>-t<span class=w> </span>zfs<span class=w> </span>main/lyz@autosnap_2023-02-17_13:15:06_hourly<span class=w> </span>/mnt
</code></pre></div> <p>To umount the snapshot run <code>umount /mnt</code>.</p> <ul> <li>Rolling back the filesystem to the snapshot state: Rolling back to a previous snapshot will discard any data changes between that snapshot and the current time. Further, by default, you can only rollback to the most recent snapshot. In order to rollback to an earlier snapshot, you must destroy all snapshots between the current time and that snapshot you wish to rollback to. If that's not enough, the filesystem must be unmounted before the rollback can begin. This means downtime.</li> </ul> <p>To rollback the "tank/test" dataset to the "tuesday" snapshot, we would issue:</p> <div class=highlight><pre><span></span><code>$:<span class=w> </span>zfs<span class=w> </span>rollback<span class=w> </span>tank/test@tuesday
cannot<span class=w> </span>rollback<span class=w> </span>to<span class=w> </span><span class=s1>&#39;tank/test@tuesday&#39;</span>:<span class=w> </span>more<span class=w> </span>recent<span class=w> </span>snapshots<span class=w> </span>exist
use<span class=w> </span><span class=s1>&#39;-r&#39;</span><span class=w> </span>to<span class=w> </span>force<span class=w> </span>deletion<span class=w> </span>of<span class=w> </span>the<span class=w> </span>following<span class=w> </span>snapshots:
tank/test@wednesday
tank/test@thursday
</code></pre></div> <p>As expected, we must remove the <code>@wednesday</code> and <code>@thursday</code> snapshots before we can rollback to the <code>@tuesday</code> snapshot.</p> <h2 id=learning>Learning<a class=headerlink href=#learning title="Permanent link">⚑</a></h2> <p>I've found that learning about ZFS was an interesting, intense and time consuming task. If you want a quick overview check <a href="https://yewtu.be/watch?v=MsY-BafQgj4">this video</a>. If you prefer to read, head to the awesome <a href=https://pthree.org/2012/04/17/install-zfs-on-debian-gnulinux/ >Aaron Toponce</a> articles and read all of them sequentially, each is a jewel. The <a href=https://openzfs.github.io/openzfs-docs/ >docs</a> on the other hand are not that pleasant to read. For further information check <a href=https://jrs-s.net/category/open-source/zfs/ >JRS articles</a>.</p> <h2 id=resources>Resources<a class=headerlink href=#resources title="Permanent link">⚑</a></h2> <ul> <li><a href=https://pthree.org/2012/04/17/install-zfs-on-debian-gnulinux/ >Aaron Toponce articles</a></li> <li><a href=https://openzfs.github.io/openzfs-docs/ >Docs</a></li> <li><a href=https://jrs-s.net/category/open-source/zfs/ >JRS articles</a></li> <li><a href="https://yewtu.be/watch?v=MsY-BafQgj4">ZFS basic introduction video</a></li> </ul> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2023-03-23T21:49:57+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-03-23</span> </small> </div> </article> </div> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../storage/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Storage" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Storage </div> </div> </a> <a href=../../zfs_storage_planning/ class="md-footer__link md-footer__link--next" aria-label="Next: OpenZFS storage planning" rel=next> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> OpenZFS storage planning </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/nullniverse target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.footer", "navigation.instant", "navigation.top", "content.code.annotate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.220ee61c.min.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> </body> </html>